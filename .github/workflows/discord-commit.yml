name: Discord Commit Notification

on:
  push:
    branches:
      - main   # adapte si tu veux d'autres branches

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Build Discord embed and send it
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          SHA: ${{ github.sha }}
        run: |
          # URL HTML du commit
          COMMIT_URL="https://github.com/$REPO/commit/$SHA"

          # Nom du commit = 1ère ligne du message
          TITLE="$(printf "%s" "$COMMIT_MESSAGE" | sed -n '1p')"

          # Description = le reste (éventuellement vide)
          DESCRIPTION="$(printf "%s" "$COMMIT_MESSAGE" | sed '1d')"
          if [ -z "$DESCRIPTION" ]; then
            DESCRIPTION="(Aucune description fournie)"
          fi

          # Timestamps
          ISO_TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"           # pour le champ timestamp
          HUMAN_TIMESTAMP="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"      # pour le footer

          # Construction du JSON de l'embed avec jq
          jq -n \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg author "$AUTHOR" \
            --arg url "$COMMIT_URL" \
            --arg title "$TITLE" \
            --arg desc "$DESCRIPTION" \
            --arg timestamp "$ISO_TIMESTAMP" \
            --arg footer "$HUMAN_TIMESTAMP" \
          '{
            embeds: [
              {
                title: $title,
                description: $desc,
                url: $url,
                timestamp: $timestamp,
                fields: [
                  { name: "Branche", value: $branch, inline: true },
                  { name: "Auteur", value: $author, inline: true },
                  { name: "Dépôt", value: $repo, inline: false }
                ]
              }
            ]
          }' > payload.json

          curl -X POST "$DISCORD_WEBHOOK" \
               -H "Content-Type: application/json" \
               -d @payload.json
